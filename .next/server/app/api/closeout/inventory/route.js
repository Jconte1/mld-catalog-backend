"use strict";(()=>{var e={};e.id=651,e.ids=[651],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},1282:e=>{e.exports=require("child_process")},4770:e=>{e.exports=require("crypto")},665:e=>{e.exports=require("dns")},7702:e=>{e.exports=require("events")},2048:e=>{e.exports=require("fs")},2615:e=>{e.exports=require("http")},5240:e=>{e.exports=require("https")},8216:e=>{e.exports=require("net")},9801:e=>{e.exports=require("os")},5315:e=>{e.exports=require("path")},6162:e=>{e.exports=require("stream")},2452:e=>{e.exports=require("tls")},7360:e=>{e.exports=require("url")},1764:e=>{e.exports=require("util")},1568:e=>{e.exports=require("zlib")},2817:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>g,patchFetch:()=>v,requestAsyncStorage:()=>h,routeModule:()=>m,serverHooks:()=>f,staticGenerationAsyncStorage:()=>y});var o={};r.r(o),r.d(o,{OPTIONS:()=>c,POST:()=>p});var n=r(9303),s=r(8716),i=r(670),a=r(6318),l=r(2221);function u(){return{"Access-Control-Allow-Origin":"https://www.mld.com","Access-Control-Allow-Credentials":"true","Access-Control-Allow-Methods":"GET,POST,PUT,PATCH,DELETE,OPTIONS","Access-Control-Allow-Headers":"Content-Type, Authorization",Vary:"Origin"}}function c(){return new Response(null,{status:204,headers:u()})}async function d(e,t){if(!t.length)return;let r=l.createTransport({service:"gmail",auth:{user:process.env.AUTO_EMAIL,pass:process.env.AUTO_EMAIL_PASSWORD}}),o=`
    <h2>Inventory Sync Failures</h2>
    <p>The following inventory items could not be processed because they were not found in the product catalog:</p>
    <table border="1" cellpadding="6" cellspacing="0">
      <thead>
        <tr>
          <th>Acumatica SKU</th>
          <th>Normalized Model Number</th>
          <th>Reason</th>
        </tr>
      </thead>
      <tbody>
        ${t.map(e=>`
          <tr>
            <td>${e.acumaticaSku}</td>
            <td>${e.modelNumber}</td>
            <td>${e.reason}</td>
          </tr>
        `).join("")}
      </tbody>
    </table>
  `;await r.sendMail({from:`"Inventory Sync" <${process.env.AUTO_EMAIL}>`,to:e,cc:process.env.CC_EMAIL,subject:"âš ï¸ Inventory Sync Failures Detected",html:o}),console.log(`âœ… Failure email sent to ${e}`)}async function p(e){try{let t=await e.json(),r=t.Inserted||[],o=t.Deleted||[];if(0===r.length&&0===o.length)return Response.json({error:"No inventory records to process"},{status:400,headers:u()});let n=[],s=[];if(r.length>0){for(let e of r){let t=(e.InventoryID||"").trim(),r=t.split(" ");if(r.length<3){console.log("âŒ Invalid acumaticaSku format. Parts:",r);continue}let o=r[1],i=o.replace(/[-\/\s]/g,""),l=e.QtyOnHand,u=e.DefaultPrice,c="number"==typeof u?u:null;console.log(`ðŸ”Ž Processing Item - acumaticaSku: "${t}", modelNumber: "${o}", normalizedModelNumber: "${i}"`);let d=await a.Z.closeout_inventory.findFirst({where:{modelNumber:i,acumaticaSku:t}});if(d)await a.Z.closeout_inventory.update({where:{id:d.id},data:{quantity:l,lastSyncedAt:new Date,price:c}}),console.log(`âœ… Updated existing closeout_inventory: "${i}"`),n.push({modelNumber:i,acumaticaSku:t,qtyOnHand:l,defaultPrice:c});else{let e=await a.Z.products.findFirst({where:{model:i}});if(!e){console.log(`âŒ Product not found in catalog for normalizedModelNumber: "${i}", acumaticaSku: "${t}"`),s.push({acumaticaSku:t,modelNumber:i,reason:"Product not found in catalog"});continue}await a.Z.closeout_inventory.create({data:{productId:e.id,modelNumber:i,acumaticaSku:t,quantity:l,lastSyncedAt:new Date,price:c}}),console.log(`âœ… Created new closeout_inventory for normalizedModelNumber: "${i}"`),n.push({modelNumber:i,acumaticaSku:t,qtyOnHand:l,defaultPrice:c})}}return s.length>0&&await d(process.env.END_USER_EMAIL,s),Response.json({success:!0,updatedRecords:n,failures:s},{headers:u()})}if(o.length>0){for(let e of o){let t=(e.InventoryID||"").trim(),r=t.split(" ");if(r.length<3){console.log("âŒ Invalid acumaticaSku format. Parts:",r);continue}let o=r[1],s=o.replace(/[-\/\s]/g,""),i=e.QtyOnHand,l=e.DefaultPrice,u="number"==typeof l?l:null;console.log(`ðŸ”Ž Processing DELETE Item - acumaticaSku: "${t}", modelNumber: "${o}", normalizedModelNumber: "${s}"`);let c=await a.Z.closeout_inventory.findFirst({where:{modelNumber:s,acumaticaSku:t}});if(c){let e=c.quantity-i;e<0&&(e=0),await a.Z.closeout_inventory.update({where:{id:c.id},data:{quantity:e,lastSyncedAt:new Date,price:u}}),console.log(`âœ… Updated quantity for existing closeout_inventory: "${s}", newQuantity: ${e}`),n.push({modelNumber:s,acumaticaSku:t,newQuantity:e})}else console.warn(`âš ï¸ No existing closeout_inventory found for acumaticaSku: "${t}"`)}return Response.json({success:!0,updatedRecords:n},{headers:u()})}}catch(e){return console.error("Error in /api/closeout/inventory:",e),Response.json({error:"Server error"},{status:500,headers:u()})}}let m=new n.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/closeout/inventory/route",pathname:"/api/closeout/inventory",filename:"route",bundlePath:"app/api/closeout/inventory/route"},resolvedPagePath:"C:\\Users\\james\\Documents\\MLDwebsite\\catalogue-backend\\app\\api\\closeout\\inventory\\route.js",nextConfigOutput:"",userland:o}),{requestAsyncStorage:h,staticGenerationAsyncStorage:y,serverHooks:f}=m,g="/api/closeout/inventory/route";function v(){return(0,i.patchFetch)({serverHooks:f,staticGenerationAsyncStorage:y})}},6318:(e,t,r)=>{r.d(t,{Z:()=>o});let o=new(require("@prisma/client")).PrismaClient}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),o=t.X(0,[176,221],()=>r(2817));module.exports=o})();